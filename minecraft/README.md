# STG-Transformer for Minecraft Tasks

Plan4MC is a multi-task agent in Minecraft, solving long-term tasks via planning over basic skills. It  acquire three types of fine-grained basic skills through reinforcement learning without demonstrations. With a skill graph pre-generated by the Large Language Model, the skill search algorithm generates skill plans and interactively selects policies to solve complicated tasks. Plan4MC accomplishes 24 diverse hard tasks in Minecraft.

## Overview

The completed steps to run our STG model for Minecraft RL tasks are as follows.

## Step 0: Set up the MineDojo environment

- We recommend you to use anaconda to create a virtual env with python >= 3.9:
  
  ```
  conda create -n mc-env python=3.9
  ```
  
- Install MineDojo following the [official doc](https://docs.minedojo.org/sections/getting_started/install.html#prerequisites). 
  
- Upgrade the MineDojo package to our modified version

    - Uninstall the previous version
        ```
        pip uninstall minedojo
        ```
    - Clone the modified repo
        ```
        git clone https://github.com/PKU-RL/MCEnv.git
        ```
    - Run the setup file
        ```
        cd MCEnv && python setup.py install 
        ```
  - Verify the installation 
      ```
      MINEDOJO_HEADLESS=1 python validate_install.py
      ```
      You should see "[INFO] Installation Success" if your installation is successful.
      
      Note that we add `MINEDOJO_HEADLESS=1` as a prefix to avoid Malmo error. This can happen when your system does not support visualization display. Otherwise, yuo can feel free to remove it.  
      
  - Clone our STG-Transformer repo
  ```
  git clone https://github.com/zhoubohan0/STG-Transformer.git
  ```

- Install python packages in `STG-Transformer/minecraft/requirements.txt`. Note that we require PyTorch >= 1.8.1 and x-transformers==0.27.1.
  ```
  pip install -r requirements.txt 
  ```
  If the speed is too low, try this:
  ```
  pip install -r requirements.txt -i https://mirrors.huaweicloud.com/repository/pypi/simple
  ```


## Step 1: Collect expert trajectories

As we discussed in our paper, we utilized the learned policy in [Plan4MC](https://github.com/PKU-RL/Plan4MC) and [CLIP4MC](https://github.com/PKU-RL/CLIP4MC) to collect our expert datasets. Specifically, 

### Task 'Milk a Cow' and Task 'Gather Wool'
- Download the [pretrained MineCLIP model](https://disk.pku.edu.cn:443/link/86843F120DF784DCC117624D2E90A569) named `attn.pth`.  Move this to the directory `minecraft/mineagent/official`.

- Run the following code in the directory `STG-Transformer/minecraft`: 

    ``` 
    python generate_expert_traj.py --task harvest_milk_with_empty_bucket_and_cow --test-episode 100
    ```
  If you encounter Malmo error, add `MINEDOJO_HEADLESS=1` at the head of this command:
  ``` 
  MINEDOJO_HEADLESS=1 python generate_expert_traj.py --task harvest_milk_with_empty_bucket_and_cow --test-episode 100
    ```

  You can see the collected expert datasets under the newly created directory `minecraft/expert_traj`. '1' indicates the trajectory collected is successful while '0' indicates the trajectory is unsuccessful; 

### Task 'arvest Tallgrass' and Task 'Pick a Flower'

For these two tasks, we trained a CLIP4MC policy from scratch and use the successful gifs saved during the training stages as our expert datasets. Please refer to [CLIP4MC](https://github.com/PKU-RL/CLIP4MC) for more details about how to train CLIP4MC policy.
